<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        body {
            background: #f8f9fa;
            font-family: '微软雅黑', Arial, sans-serif;
        }
        .main-title {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: #0c5460;
            margin-top: 20px;
            letter-spacing: 2px;
        }
        .date-range {
            text-align: center;
            font-size: 1.3rem;
            color: #0c5460;
            margin-bottom: 20px;
        }
        .classroom-title {
            text-align: center;
            font-size: 1.4rem;
            font-weight: bold;
            color: #0c5460;
            margin: 20px 0 15px 0;
            letter-spacing: 1px;
            position: relative;
        }
        .delete-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .delete-btn:hover {
            background: #138496;
        }
        /* 表格容器 */
        .table-scroll-container {
            width: 100%;
            margin: 0 auto 25px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        
        .schedule-table {
            border-collapse: collapse;
            width: 100%;
            position: relative;
            table-layout: fixed;
        }
        

        .schedule-table th, .schedule-table td {
            border: 1px solid #e0e0e0;
            text-align: center;
            padding: 4px 2px;
            font-size: 0.75rem;
            white-space: pre-line;
            vertical-align: middle;
            height: 35px;
            line-height: 1.2;
        }
        .schedule-table th {
            background: #d1ecf1;
            color: #0c5460;
            font-weight: bold;
        }
        .schedule-table td {
            background: #fff;
        }
        .schedule-table .subject-chemistry {
            background: #ffd6af !important;
            color: #333;
            font-weight: bold;
            font-size: 0.7rem;
        }
        .schedule-table .subject-math {
            background: #c7d8f4 !important;
            color: #333;
            font-weight: bold;
            font-size: 0.7rem;
        }
        .schedule-table .subject-physics {
            background: #ffb3b3 !important;
            color: #333;
            font-weight: bold;
            font-size: 0.7rem;
        }
        .schedule-table .subject-chinese {
            background: #ffe4e1 !important;
            color: #333;
            font-weight: bold;
            font-size: 0.7rem;
        }
        .schedule-table .subject-english {
            background: #d4ffd4 !important;
            color: #333;
            font-weight: bold;
            font-size: 0.7rem;
        }
        .schedule-table .subject-politics {
            background: #e6d3ff !important;
            color: #333;
            font-weight: bold;
            font-size: 0.7rem;
        }
        .schedule-table .subject-history {
            background: #fff8dc !important;
            color: #333;
            font-weight: bold;
            font-size: 0.7rem;
        }
        .schedule-table .subject-geography {
            background: #b3e5fc !important;
            color: #333;
            font-weight: bold;
            font-size: 0.7rem;
        }
        .rest-cell {
            background: #f8f8f8;
            color: #888;
            font-size: 1.1rem;
        }
        .time-label {
            background: #d1ecf1;
            color: #0c5460;
            font-weight: bold;
            width: 80px;
            font-size: 0.7rem;
            padding: 2px 1px;
        }
        .period-label {
            background: #d1ecf1 !important;
            color: #0c5460 !important;
            font-weight: bold;
            width: 50px;
            vertical-align: middle;
            text-align: center;
            font-size: 0.7rem;
            padding: 2px 1px;
        }
        /* 教室课表只读样式 */
        .classroom-readonly {
            cursor: default !important;
            position: relative;
        }
        .classroom-readonly:hover::after {
            content: "教室课表只读，请在学生课表中编辑";
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
        /* 新增：拖拽和选中样式 */
        .cell-selected {
            background-color: rgba(76, 175, 80, 0.3) !important;
            border: 2px solid #4CAF50 !important;
        }
        .cell-drag-source {
            border: 2px solid #2196F3 !important;
            background-color: rgba(33, 150, 243, 0.2) !important;
        }
        .cell-drag-target {
            border: 2px dashed #9C27B0 !important;
            background-color: rgba(156, 39, 176, 0.1) !important;
        }
        .dragging-cursor {
            cursor: copy !important;
        }
        /* 鼠标悬停高亮效果 */
        .row-highlight {
            background-color: rgba(33, 150, 243, 0.1) !important;
            transition: background-color 0.1s ease;
        }
        .col-highlight {
            background-color: rgba(33, 150, 243, 0.1) !important;
            transition: background-color 0.1s ease;
        }
        .cell-highlight {
            background-color: rgba(33, 150, 243, 0.2) !important;
            border: 2px solid #2196F3 !important;
            transition: all 0.1s ease;
        }
        /* 确保高亮效果覆盖科目颜色 */
        .subject-chemistry.row-highlight,
        .subject-chemistry.col-highlight {
            background-color: rgba(255, 214, 175, 0.8) !important;
        }
        .subject-math.row-highlight,
        .subject-math.col-highlight {
            background-color: rgba(199, 216, 244, 0.8) !important;
        }
        .subject-physics.row-highlight,
        .subject-physics.col-highlight {
            background-color: rgba(255, 179, 179, 0.8) !important;
        }
        .subject-chinese.row-highlight,
        .subject-chinese.col-highlight {
            background-color: rgba(255, 228, 225, 0.8) !important;
        }
        .subject-english.row-highlight,
        .subject-english.col-highlight {
            background-color: rgba(212, 255, 212, 0.8) !important;
        }
        .subject-politics.row-highlight,
        .subject-politics.col-highlight {
            background-color: rgba(230, 211, 255, 0.8) !important;
        }
        .subject-history.row-highlight,
        .subject-history.col-highlight {
            background-color: rgba(255, 248, 220, 0.8) !important;
        }
        .subject-geography.row-highlight,
        .subject-geography.col-highlight {
            background-color: rgba(179, 229, 252, 0.8) !important;
        }
        .undo-hint {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .undo-hint.show {
            opacity: 1;
        }
        .type-switch {
            text-align: center;
            margin-bottom: 20px;
        }
        .type-switch button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }
        .type-switch button.active {
            background: #138496;
        }
        .type-switch button:hover {
            background: #138496;
        }
        .admin-back-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s;
        }
        .admin-back-btn:hover {
            background: #138496;
            color: white;
            text-decoration: none;
        }
        .add-schedule-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 20px auto;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            display: block;
        }
        .add-schedule-btn:hover {
            background: #138496;
        }

        /* 批量按周创建控制区 */
        .repeat-controls {
            text-align: center;
            margin: -8px 0 16px 0;
            color: #0c5460;
            font-size: 0.95rem;
        }
        .repeat-controls input[type="date"] {
            margin: 0 6px;
            padding: 4px 6px;
            font-size: 0.95rem;
        }
        .repeat-controls label {
            margin: 0 6px;
            user-select: none;
        }

    </style>
</head>
<body>
    <div class="main-title">{{ title }}</div>
    <div class="date-range">{{ date_range }}</div>
    <div style="text-align:center; margin-bottom: 18px;">
        <form id="monthForm" style="display:inline-block;">
            <label style="font-weight:bold;color:#0c5460;">选择校区：</label>
            <select id="campusSelect" name="campus" style="margin-right:10px;">
                <option value="wendefu" {% if current_campus == 'wendefu' %}selected{% endif %}>文德福</option>
                <option value="cuihai" {% if current_campus == 'cuihai' %}selected{% endif %}>翠海</option>
                <option value="weipeng" {% if current_campus == 'weipeng' %}selected{% endif %}>玮鹏</option>
            </select>
            <label style="font-weight:bold;color:#0c5460;">选择月份：</label>
            <select id="yearSelect" name="year" style="margin-right:6px;"></select>
            <select id="monthSelect" name="month" style="margin-right:10px;"></select>
            <span id="studentSelectContainer" style="display:none;">
                <label style="font-weight:bold;color:#0c5460;">选择学生：</label>
                <select id="studentSelect" name="student" style="margin-right:10px;">
                    <option value="">请选择学生</option>
                </select>
            </span>
            <span id="classroomSelectContainer" style="display:none;">
                <label style="font-weight:bold;color:#0c5460;">选择教室：</label>
                <select id="classroomSelect" name="classroom" style="margin-right:10px;">
                    <option value="">查看所有教室</option>
                </select>
            </span>
        </form>
    </div>

    <!-- 课表类型切换 -->
    <div class="type-switch">
        <button id="classroomBtn">教室课表</button>
        <button id="studentBtn">学生课表</button>
        {% if is_admin %}
        <a href="/admin" class="admin-back-btn">返回管理员页面</a>
        {% else %}
        <a href="{{ url_for('update_schedule') }}" class="admin-back-btn">返回课表页面</a>
        {% endif %}
    </div>

    {% if is_admin %}
    <!-- 批量按周创建控制区（仅管理员可见，学生课表模式下显示） -->
    <div id="repeatControls" class="repeat-controls" style="display:none;">
        <label>
            <input id="repeatToggle" type="checkbox" /> 启用按周批量创建
        </label>
        <label>开始日期：<input id="repeatStart" type="date" /></label>
        <label>结束日期：<input id="repeatEnd" type="date" /></label>
    </div>
    {% endif %}

    <!-- 新增学生课表按钮 -->
    {% if is_admin %}
    <button id="addStudentBtn" class="add-schedule-btn">
        新增学生课表
    </button>
    {% endif %}

    <!-- 多个课程表容器 -->
    <div id="classroomContainer">
        <!-- 课程表将由JavaScript动态生成 -->
    </div>

    <!-- 撤回提示 -->
    <div id="undoHint" class="undo-hint">
        按 Ctrl+Z 可撤回操作
    </div>

    <script>
        // 校区和对应的教室配置
        const campusClassrooms = {
            'wendefu': ['a', 'b', 'c'],  // 文德福3个教室
            'cuihai': ['a', 'b'],             // 翠海2个教室
            'weipeng': ['a', 'b', 'c', 'd', 'e']  // 玮鹏5个教室
        };

        // 时间段配置
        const timeSlots = [
            "8:00-9:00", "9:00-10:00", "10:00-11:00", "11:00-12:00",
            "14:00-15:00", "15:00-16:00", "16:00-17:00", "17:00-18:00",
            "19:00-20:00", "20:00-21:00"
        ];

        // ========== 全局变量 ===========
        const currentMonth = "{{ current_month }}";
        const currentCampus = "{{ current_campus }}";
        const currentType = "{{ current_type }}";
        const currentUser = "{{ current_user }}";
        const isAdmin = ("{{ 'true' if is_admin else 'false' }}".toLowerCase() === 'true');
        const [curYear, curMonth] = currentMonth.split('-');
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const campusSelect = document.getElementById('campusSelect');
        const classroomBtn = document.getElementById('classroomBtn');
        const studentBtn = document.getElementById('studentBtn');
        const addStudentBtn = document.getElementById('addStudentBtn'); // 可能为null（对于非管理员用户）
        const studentSelectContainer = document.getElementById('studentSelectContainer');
        const studentSelect = document.getElementById('studentSelect');
        const classroomSelectContainer = document.getElementById('classroomSelectContainer');
        const classroomSelect = document.getElementById('classroomSelect');
        // 批量创建控件（仅管理员存在）
        const repeatControls = isAdmin ? document.getElementById('repeatControls') : null;
        const repeatToggle = isAdmin ? document.getElementById('repeatToggle') : null;
        const repeatStart = isAdmin ? document.getElementById('repeatStart') : null;
        const repeatEnd = isAdmin ? document.getElementById('repeatEnd') : null;
        
        // ========== 拖拽和撤回相关变量 ===========
        let operationHistory = []; // 操作历史栈
        let currentHistoryIndex = -1; // 当前历史位置
        let isDragging = false; // 是否正在拖拽
        let dragStartCell = null; // 拖拽起始单元格
        let draggedCells = []; // 拖拽经过的单元格
        let selectedCell = null; // 当前选中的单元格
        let lastClickTime = 0; // 上次点击时间，用于判断双击
        
        // 年份范围
        for(let y=2020; y<=2030; y++) {
            let opt = document.createElement('option');
            opt.value = y;
            opt.text = y + '年';
            if(y == curYear) opt.selected = true;
            yearSelect.appendChild(opt);
        }
        
        // 月份
        for(let m=1; m<=12; m++) {
            let opt = document.createElement('option');
            opt.value = (m<10 ? '0'+m : m);
            opt.text = m + '月';
            if(m == parseInt(curMonth)) opt.selected = true;
            monthSelect.appendChild(opt);
        }
        
        // 课表类型切换
        let currentScheduleType = currentType;
        
        classroomBtn.onclick = function() {
            if (currentScheduleType !== 'classroom') {
                currentScheduleType = 'classroom';
                updateTypeButtons();
                updateURL();
                loadScheduleData();
            }
        };
        
        studentBtn.onclick = function() {
            if (currentScheduleType !== 'student') {
                currentScheduleType = 'student';
                updateTypeButtons();
                updateURL();
                loadScheduleData();
            }
        };
        
        // 更新按钮状态
        function updateTypeButtons() {
            // 切换课表类型时清除所有状态
            clearDragState();
            clearCellSelection();
            
            // 如果从学生课表切换到其他类型，重置历史记录
            if (currentScheduleType !== 'student') {
                operationHistory = [];
                currentHistoryIndex = -1;
            }
            
            classroomBtn.classList.toggle('active', currentScheduleType === 'classroom');
            studentBtn.classList.toggle('active', currentScheduleType === 'student');
            if (addStudentBtn) {
                addStudentBtn.style.display = currentScheduleType === 'student' && isAdmin ? 'block' : 'none';
            }
            if (repeatControls) {
                repeatControls.style.display = (currentScheduleType === 'student' && isAdmin) ? 'block' : 'none';
            }
            
            // 显示/隐藏学生选择框
            if (currentScheduleType === 'student') {
                studentSelectContainer.style.display = 'inline';
                loadStudentList(); // 加载学生列表
            } else {
                studentSelectContainer.style.display = 'none';
            }
            
            // 显示/隐藏教室选择框
            if (currentScheduleType === 'classroom') {
                classroomSelectContainer.style.display = 'inline';
                loadClassroomList(); // 加载教室列表
            } else {
                classroomSelectContainer.style.display = 'none';
            }
        }
        
        // 更新URL
        function updateURL() {
            const y = yearSelect.value;
            const m = monthSelect.value;
            const campus = campusSelect.value;
            let newUrl = `?month=${y}-${m}&campus=${campus}&type=${currentScheduleType}`;
            
            // 如果是学生课表模式且选择了学生，添加student参数
            if (currentScheduleType === 'student' && studentSelect.value) {
                newUrl += `&student=${encodeURIComponent(studentSelect.value)}`;
            }

            // 如果是教室课表模式且选择了教室，添加classroom参数
            if (currentScheduleType === 'classroom' && classroomSelect.value) {
                newUrl += `&classroom=${encodeURIComponent(classroomSelect.value)}`;
            }
            
            window.history.pushState({}, '', newUrl);
        }
        
        // 切换时动态更新页面
        yearSelect.onchange = monthSelect.onchange = campusSelect.onchange = function() {
            updateURL();
            updateDateRange();
            if (currentScheduleType === 'student') {
                loadStudentList(); // 校区或月份改变时重新加载学生列表
            } else if (currentScheduleType === 'classroom') {
                loadClassroomList(); // 校区或月份改变时重新加载教室列表
            } else {
                loadScheduleData();
            }
        };
        
        // 学生选择框事件
        studentSelect.onchange = function() {
            if (currentScheduleType === 'student') {
                updateURL();
                loadScheduleData();
            }
        };

        // 教室选择框事件
        classroomSelect.onchange = function() {
            if (currentScheduleType === 'classroom') {
                updateURL();
                loadScheduleData();
            }
        };

        // 加载学生列表
        function loadStudentList() {
            const month = yearSelect.value + '-' + monthSelect.value;
            fetch(`/campus_schedule_data?month=${month}&campus=${campusSelect.value}&type=student`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 清空现有选项
                        studentSelect.innerHTML = '<option value="">请选择学生</option>';
                        
                        // 添加学生选项
                        data.schedules_list.forEach(studentName => {
                            const option = document.createElement('option');
                            option.value = studentName;
                            option.textContent = studentName;
                            studentSelect.appendChild(option);
                        });
                        
                        // 如果URL中有student参数，设置选中状态
                        const urlParams = new URLSearchParams(window.location.search);
                        const selectedStudent = urlParams.get('student');
                        if (selectedStudent && data.schedules_list.includes(selectedStudent)) {
                            studentSelect.value = selectedStudent;
                        } else if (data.schedules_list.length > 0) {
                            // 如果没有URL参数，默认选择第一个学生
                            studentSelect.value = data.schedules_list[0];
                            // 更新URL以反映默认选择
                            updateURL();
                        }
                        
                        // 加载课表数据
                        loadScheduleData();
                    }
                })
                .catch(error => {
                    console.error('Error loading student list:', error);
                });
        }

        // 加载教室列表
        function loadClassroomList() {
            const month = yearSelect.value + '-' + monthSelect.value;
            const campus = campusSelect.value;
            const selectedClassroom = classroomSelect.value;
            fetch(`/campus_schedule_data?month=${month}&campus=${campus}&type=classroom&classroom=${selectedClassroom}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 清空现有选项
                        classroomSelect.innerHTML = '<option value="">查看所有教室</option>';
                        
                        // 添加教室选项
                        data.schedules_list.forEach(classroomName => {
                            const option = document.createElement('option');
                            option.value = classroomName;
                            option.textContent = `教室${classroomName.toUpperCase()}`;
                            classroomSelect.appendChild(option);
                        });
                        
                        // 如果URL中有classroom参数，设置选中状态
                        const urlParams = new URLSearchParams(window.location.search);
                        const selectedClassroomFromUrl = urlParams.get('classroom');
                        if (selectedClassroomFromUrl && data.schedules_list.includes(selectedClassroomFromUrl)) {
                            classroomSelect.value = selectedClassroomFromUrl;
                        } else {
                            // 如果没有URL参数，默认选择查看所有教室
                            classroomSelect.value = '';
                            // 更新URL以反映默认选择
                            updateURL();
                        }
                        
                        // 加载课表数据
                        loadScheduleData();
                    }
                })
                .catch(error => {
                    console.error('Error loading classroom list:', error);
                });
        }

        // 新增学生课表
        if (addStudentBtn) {
            addStudentBtn.onclick = function() {
            const studentName = prompt('请输入学生课表名称：');
            if (studentName && studentName.trim()) {
                const month = yearSelect.value + '-' + monthSelect.value;
                fetch('/add_student_schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        month: month,
                        campus: campusSelect.value,
                        student_name: studentName.trim()
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 重新加载学生列表
                        loadStudentList();
                        // 自动选择新创建的学生
                        setTimeout(() => {
                            studentSelect.value = studentName.trim();
                            loadScheduleData();
                        }, 100);
                    } else {
                        alert('添加失败: ' + (data.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('添加失败: 网络错误');
                });
            }
            };
        }

        // ========== 拖拽和撤回功能实现 ===========
        
        // 保存操作状态到历史栈
        function saveStateForUndo() {
            const currentState = getCurrentScheduleState();
            if (currentState) {
                // 删除当前位置之后的历史记录
                operationHistory = operationHistory.slice(0, currentHistoryIndex + 1);
                operationHistory.push(currentState);
                currentHistoryIndex++;
                
                // 限制历史记录数量，避免内存过大
                if (operationHistory.length > 20) {
                    operationHistory = operationHistory.slice(-20);
                    currentHistoryIndex = 19;
                }
                
                showUndoHint();
            }
        }
        
        // 获取当前课表状态
        function getCurrentScheduleState() {
            if (currentScheduleType !== 'student' || !studentSelect.value) {
                return null;
            }
            
            const state = {
                type: currentScheduleType,
                student: studentSelect.value,
                month: yearSelect.value + '-' + monthSelect.value,
                campus: campusSelect.value,
                cells: []
            };
            
            const table = document.querySelector(`#schedule-${studentSelect.value}-table`);
            if (table) {
                const cells = table.querySelectorAll('td[data-student]');
                cells.forEach(cell => {
                    const row = parseInt(cell.getAttribute('data-row'));
                    const col = parseInt(cell.getAttribute('data-col'));
                    const content = cell.textContent.trim();
                    state.cells.push({
                        row: row,
                        col: col,
                        content: content
                    });
                });
            }
            
            return state;
        }
        
        // 恢复到指定状态
        function restoreState(state) {
            if (!state || state.type !== 'student') {
                return;
            }
            
            // 确保当前选择的学生和状态中的一致
            if (studentSelect.value !== state.student) {
                studentSelect.value = state.student;
            }
            
            const table = document.querySelector(`#schedule-${state.student}-table`);
            if (table) {
                const cells = table.querySelectorAll('td[data-student]');
                
                // 先清空所有单元格
                cells.forEach(cell => {
                    updateCellDisplay(cell, '');
                });
                
                // 恢复状态中的内容
                state.cells.forEach(cellData => {
                    const cell = table.querySelector(`td[data-row="${cellData.row}"][data-col="${cellData.col}"]`);
                    if (cell) {
                        updateCellDisplay(cell, cellData.content);
                    }
                });
            }
        }
        
        // 执行撤回操作
        function performUndo() {
            if (currentHistoryIndex > 0) {
                currentHistoryIndex--;
                const targetState = operationHistory[currentHistoryIndex];
                restoreState(targetState);
                
                // 批量更新服务器
                updateServerWithState(targetState);
            }
        }
        
        // 批量更新服务器状态
        function updateServerWithState(state) {
            if (!state || state.type !== 'student') {
                return;
            }
            
            const promises = [];
            
            state.cells.forEach(cellData => {
                const requestData = {
                    month: state.month,
                    campus: state.campus,
                    type: 'student',
                    day_index: cellData.col,
                    time_slot_index: cellData.row,
                    subject: cellData.content,
                    day_label: '', // 这些在服务器端会被重新计算
                    time_slot: '',
                    student_name: state.student
                };
                
                promises.push(
                    fetch('/campus_schedule', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData)
                    })
                );
            });
            
            // 等待所有请求完成
            Promise.all(promises).then(responses => {
                console.log('Undo operation completed');
            }).catch(error => {
                console.error('Error during undo:', error);
            });
        }
        
        // 显示撤回提示
        function showUndoHint() {
            const hint = document.getElementById('undoHint');
            hint.classList.add('show');
            setTimeout(() => {
                hint.classList.remove('show');
            }, 2000);
        }
        
        // 清除单元格选中状态
        function clearCellSelection() {
            document.querySelectorAll('.cell-selected').forEach(cell => {
                cell.classList.remove('cell-selected');
            });
            selectedCell = null;
            // 同时清除高亮效果
            clearHighlight();
        }
        
        // 清除拖拽状态
        function clearDragState() {
            document.querySelectorAll('.cell-drag-source, .cell-drag-target').forEach(cell => {
                cell.classList.remove('cell-drag-source', 'cell-drag-target');
            });
            document.body.classList.remove('dragging-cursor');
            isDragging = false;
            dragStartCell = null;
            draggedCells = [];
            // 同时清除高亮效果
            clearHighlight();
        }
        
        // 开始拖拽
        function startDrag(cell) {
            if (!isAdmin || currentScheduleType !== 'student' || !cell.textContent.trim()) {
                return false;
            }
            
            // 保存当前状态用于撤回
            saveStateForUndo();
            
            isDragging = true;
            dragStartCell = cell;
            draggedCells = [cell];
            
            cell.classList.add('cell-drag-source');
            document.body.classList.add('dragging-cursor');
            
            return true;
        }
        
        // 处理拖拽移动
        function handleDragMove(cell) {
            if (!isDragging || !dragStartCell) {
                return;
            }
            
            // 确保在同一个学生或教室内拖动
            const startStudent = dragStartCell.getAttribute('data-student');
            const startClassroom = dragStartCell.getAttribute('data-classroom');
            const currentStudent = cell.getAttribute('data-student');
            const currentClassroom = cell.getAttribute('data-classroom');
            
            if (startStudent !== currentStudent || startClassroom !== currentClassroom) {
                return;
            }
            
            // 获取起始和当前单元格的行列坐标
            const startRow = parseInt(dragStartCell.getAttribute('data-row'));
            const startCol = parseInt(dragStartCell.getAttribute('data-col'));
            const currentRow = parseInt(cell.getAttribute('data-row'));
            const currentCol = parseInt(cell.getAttribute('data-col'));
            
            // 计算矩形范围
            const minRow = Math.min(startRow, currentRow);
            const maxRow = Math.max(startRow, currentRow);
            const minCol = Math.min(startCol, currentCol);
            const maxCol = Math.max(startCol, currentCol);
            
            // 清除之前的拖拽目标标记
            draggedCells.forEach(c => c.classList.remove('cell-drag-target'));
            draggedCells = [dragStartCell];
            
            // 找到矩形区域内的所有单元格
            const allCells = document.querySelectorAll('td[data-row][data-col]');
            allCells.forEach(c => {
                const cellRow = parseInt(c.getAttribute('data-row'));
                const cellCol = parseInt(c.getAttribute('data-col'));
                const cellStudent = c.getAttribute('data-student');
                const cellClassroom = c.getAttribute('data-classroom');
                
                // 检查是否在矩形范围内且属于同一个学生/教室
                if (cellRow >= minRow && cellRow <= maxRow && 
                    cellCol >= minCol && cellCol <= maxCol &&
                    cellStudent === startStudent && cellClassroom === startClassroom) {
                    if (c !== dragStartCell) {
                        draggedCells.push(c);
                        c.classList.add('cell-drag-target');
                    }
                }
            });
        }
        
        // 结束拖拽
        function endDrag() {
            if (!isDragging || !dragStartCell || draggedCells.length <= 1) {
                clearDragState();
                return;
            }
            
            const sourceContent = dragStartCell.textContent.trim();
            const promises = [];
            const cellsForBatchCreate = []; // 记录需要批量创建的单元格信息
            const cellsForBatchDelete = []; // 记录需要批量删除的单元格信息
            
            // 复制内容到所有拖拽经过的单元格
            draggedCells.forEach(cell => {
                if (cell !== dragStartCell) {
                    const originalContent = cell.textContent.trim(); // 记录原始内容
                    updateCellDisplay(cell, sourceContent);
                    
                    // 准备服务器更新请求
                    const row = parseInt(cell.getAttribute('data-row'));
                    const col = parseInt(cell.getAttribute('data-col'));
                    const day = cell.getAttribute('data-day');
                    const time = cell.getAttribute('data-time');
                    const student = cell.getAttribute('data-student');
                    
                    const requestData = {
                        month: yearSelect.value + '-' + monthSelect.value,
                        campus: campusSelect.value,
                        type: 'student',
                        day_index: col,
                        time_slot_index: row,
                        subject: sourceContent,
                        day_label: day,
                        time_slot: time,
                        student_name: student
                    };
                    
                    promises.push(
                        fetch('/campus_schedule', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestData)
                        })
                    );
                    
                    // 如果开启批量创建，只要拖动的是有内容的格子就触发（包括创建和覆盖）
                    if (isAdmin && currentScheduleType === 'student' && repeatToggle && repeatToggle.checked && sourceContent) {
                        cellsForBatchCreate.push({
                            rowIndex: row,
                            colIndex: col,
                            studentName: student
                        });
                    }
                    
                    // 如果开启批量删除且拖动空内容到有内容的格子，记录下来
                    if (isAdmin && currentScheduleType === 'student' && repeatToggle && repeatToggle.checked && !sourceContent && originalContent) {
                        cellsForBatchDelete.push({
                            rowIndex: row,
                            colIndex: col,
                            studentName: student
                        });
                    }
                }
            });
            
            // 批量发送请求到服务器
            Promise.all(promises).then(responses => {
                console.log('Drag fill completed');
                
                // 如果有需要批量创建的单元格，逐个触发批量创建
                if (cellsForBatchCreate.length > 0) {
                    cellsForBatchCreate.forEach(cellInfo => {
                        batchCreateWeekly(sourceContent, cellInfo.rowIndex, cellInfo.colIndex, cellInfo.studentName);
                    });
                }
                
                // 如果有需要批量删除的单元格，逐个触发批量删除
                if (cellsForBatchDelete.length > 0) {
                    cellsForBatchDelete.forEach(cellInfo => {
                        batchDeleteWeekly(cellInfo.rowIndex, cellInfo.colIndex, cellInfo.studentName);
                    });
                }
            }).catch(error => {
                console.error('Error during drag fill:', error);
                // 如果出错，重新加载数据
                loadScheduleData();
            });
            
            clearDragState();
        }
        
        // 键盘事件监听（Ctrl+Z撤回）
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'z' && currentScheduleType === 'student') {
                e.preventDefault();
                performUndo();
            }
        });
        
        // 全局鼠标事件监听
        document.addEventListener('mouseup', function(e) {
            if (isDragging) {
                endDrag();
            }
        });
        
        // 全局点击事件监听（点击其他地方取消选中）
        document.addEventListener('click', function(e) {
            // 如果点击的不是单元格，清除选中状态
            if (!e.target.closest('td[data-student], td[data-classroom]')) {
                clearCellSelection();
            }
        });
        
        // 页面加载时加载当前校区的数据
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化按钮状态
            updateTypeButtons();
            
            // 从URL参数中获取初始选择
            const urlParams = new URLSearchParams(window.location.search);
            const urlStudent = urlParams.get('student');
            const urlClassroom = urlParams.get('classroom');
            
            setTimeout(function() {
                if (currentScheduleType === 'student') {
                    loadStudentList(); // 学生模式下先加载学生列表
                    // 如果没有URL student参数，设置默认选择第一个学生
                    if (!urlStudent) {
                        setTimeout(() => {
                            if (!studentSelect.value && studentSelect.options.length > 1) {
                                studentSelect.value = studentSelect.options[1].value; // 跳过第一个"请选择学生"选项
                                updateURL();
                            }
                        }, 200);
                    }
                } else if (currentScheduleType === 'classroom') {
                    loadClassroomList(); // 教室模式下先加载教室列表
                    // 如果没有URL classroom参数，设置默认选择教室a
                    if (!urlClassroom) {
                        setTimeout(() => {
                            if (!classroomSelect.value && campusClassrooms[campusSelect.value].includes('a')) {
                                classroomSelect.value = 'a';
                                updateURL();
                            }
                        }, 200);
                    }
                } else {
                    loadScheduleData(); // 其他模式直接加载数据
                }
                updateDateRange();
                // 初始化批量创建日期默认值（仅管理员）
                if (isAdmin && repeatStart && repeatEnd && (!repeatStart.value || !repeatEnd.value)) {
                    const y = yearSelect.value;
                    const m = monthSelect.value;
                    const first = `${y}-${m}-01`;
                    const last = `${y}-${m}-${String(getLastDayOfMonth(y, m)).padStart(2, '0')}`;
                    repeatStart.value = first;
                    repeatEnd.value = last;
                }
            }, 100);
        });

        // 加载课表数据
        function loadScheduleData() {
            // 清除拖拽和选中状态
            clearDragState();
            clearCellSelection();
            
            // 如果切换了学生或月份，重置历史记录
            const currentState = getCurrentScheduleState();
            if (currentState && (operationHistory.length === 0 || 
                operationHistory[operationHistory.length - 1]?.student !== currentState.student ||
                operationHistory[operationHistory.length - 1]?.month !== currentState.month)) {
                operationHistory = [];
                currentHistoryIndex = -1;
            }
            
            const month = yearSelect.value + '-' + monthSelect.value;
            const campus = campusSelect.value;
            const type = currentScheduleType;
            let url = `/campus_schedule_data?month=${month}&campus=${campus}&type=${type}`;
            
            if (type === 'student' && studentSelect.value) {
                url += `&student=${encodeURIComponent(studentSelect.value)}`;
            } else if (type === 'classroom' && classroomSelect.value) {
                url += `&classroom=${encodeURIComponent(classroomSelect.value)}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Received data:', data);
                    if (data.success) {
                        generateScheduleTables(data.all_schedules, data.schedules_list, data.days, data.type);
                    } else {
                        console.error('Failed to load data:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                });
        }

        // 生成课程表
        function generateScheduleTables(allSchedules, schedulesList, days, type) {
            const container = document.getElementById('classroomContainer');
            container.innerHTML = '';

            if (!allSchedules || !schedulesList || !days) {
                console.error('Missing required data:', { allSchedules, schedulesList, days });
                return;
            }

            // 如果是学生课表模式，只显示选中的学生
            let displayList = schedulesList;
            if (type === 'student') {
                const selectedStudent = studentSelect.value;
                if (selectedStudent && schedulesList.includes(selectedStudent)) {
                    displayList = [selectedStudent];
                } else {
                    // 如果没有选择学生或选择的学生不存在，显示提示
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">请选择要查看的学生课程表</div>';
                    return;
                }
            } else if (type === 'classroom') {
                const selectedClassroom = classroomSelect.value;
                if (selectedClassroom && schedulesList.includes(selectedClassroom)) {
                    // 如果选择了特定教室，只显示该教室
                    displayList = [selectedClassroom];
                } else {
                    // 如果没有选择教室，显示所有教室（与管理员一样）
                    displayList = schedulesList;
                }
            }

            displayList.forEach(scheduleName => {
                // 创建标题
                const titleDiv = document.createElement('div');
                titleDiv.className = 'classroom-title';
                
                if (type === 'classroom') {
                    titleDiv.textContent = `教室${scheduleName.toUpperCase()}`;
                } else {
                    titleDiv.textContent = scheduleName;
                    
                    // 为学生课表添加删除按钮（只有管理员可见）
                    if (isAdmin) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.textContent = '删除';
                        deleteBtn.onclick = function() {
                            if (confirm(`确定要删除课表"${scheduleName}"吗？`)) {
                                deleteStudentSchedule(scheduleName);
                            }
                        };
                        titleDiv.appendChild(deleteBtn);
                    }
                }
                
                container.appendChild(titleDiv);

                // 创建表格滚动容器
                const scrollContainer = document.createElement('div');
                scrollContainer.className = 'table-scroll-container';

                // 创建课程表
                const table = document.createElement('table');
                table.className = 'schedule-table';
                table.id = `schedule-${scheduleName}-table`;

                // 创建表头
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                // 时间/日期列
                const timeHeader = document.createElement('th');
                timeHeader.className = 'time-label';
                timeHeader.textContent = '时间/日期';
                headerRow.appendChild(timeHeader);
                
                // 时段列
                const periodHeader = document.createElement('th');
                periodHeader.className = 'period-label';
                periodHeader.textContent = '时段';
                headerRow.appendChild(periodHeader);
                
                // 日期列
                days.forEach(day => {
                    const dayHeader = document.createElement('th');
                    dayHeader.textContent = day;
                    headerRow.appendChild(dayHeader);
                });
                
                thead.appendChild(headerRow);
                table.appendChild(thead);

                // 创建表体
                const tbody = document.createElement('tbody');
                
                for (let rowIdx = 0; rowIdx < timeSlots.length; rowIdx++) {
                    const row = document.createElement('tr');
                    
                    // 时间列
                    const timeCell = document.createElement('th');
                    timeCell.className = 'time-label';
                    timeCell.textContent = timeSlots[rowIdx];
                    row.appendChild(timeCell);
                    
                    // 时段列
                    if (rowIdx === 0) {
                        const periodCell = document.createElement('td');
                        periodCell.className = 'period-label';
                        periodCell.textContent = '上午';
                        periodCell.rowSpan = 4;
                        row.appendChild(periodCell);
                    } else if (rowIdx === 4) {
                        const periodCell = document.createElement('td');
                        periodCell.className = 'period-label';
                        periodCell.textContent = '下午';
                        periodCell.rowSpan = 4;
                        row.appendChild(periodCell);
                    } else if (rowIdx === 8) {
                        const periodCell = document.createElement('td');
                        periodCell.className = 'period-label';
                        periodCell.textContent = '晚上';
                        periodCell.rowSpan = 2;
                        row.appendChild(periodCell);
                    }
                    
                    // 日期列
                    for (let colIdx = 0; colIdx < days.length; colIdx++) {
                        const cell = document.createElement('td');
                        cell.style.cursor = 'pointer';
                        cell.setAttribute('data-row', rowIdx);
                        cell.setAttribute('data-col', colIdx);
                        cell.setAttribute('data-day', days[colIdx]);
                        cell.setAttribute('data-time', timeSlots[rowIdx]);
                        
                        if (type === 'classroom') {
                            cell.setAttribute('data-classroom', scheduleName);
                            // 为教室课表添加只读样式
                            cell.classList.add('classroom-readonly');
                    } else {
                            cell.setAttribute('data-student', scheduleName);
                        }
                        
                        // 新的事件处理：单击选中，双击编辑，支持拖拽
                        cell.addEventListener('click', function(e) { 
                            handleCellClick(this, e); 
                        });
                        cell.addEventListener('mousedown', function(e) { 
                            handleCellMouseDown(this, e); 
                        });
                        cell.addEventListener('mouseenter', function(e) { 
                            handleCellMouseEnter(this, e); 
                        });
                        cell.addEventListener('mouseleave', function(e) { 
                            handleCellMouseLeave(this, e); 
                        });
                        
                        // 填充数据
                        const scheduleData = allSchedules[scheduleName];
                        if (scheduleData && scheduleData[rowIdx] && scheduleData[rowIdx][colIdx]) {
                            const subject = scheduleData[rowIdx][colIdx];
                            updateCellDisplay(cell, subject);
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    tbody.appendChild(row);
                }
                
                table.appendChild(tbody);
                scrollContainer.appendChild(table);
                container.appendChild(scrollContainer);
            });
            
            // 如果是学生课表，保存初始状态到历史记录
            if (type === 'student' && displayList.length > 0 && operationHistory.length === 0) {
                setTimeout(() => {
                    const initialState = getCurrentScheduleState();
                    if (initialState) {
                        operationHistory = [initialState];
                        currentHistoryIndex = 0;
                    }
                }, 100);
            }
        }

        // 删除学生课表
        function deleteStudentSchedule(studentName) {
            const month = yearSelect.value + '-' + monthSelect.value;
            fetch('/delete_student_schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    month: month,
                    campus: campusSelect.value,
                    student_name: studentName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadScheduleData();
                } else {
                    alert('删除失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败: 网络错误');
            });
        }

        // 更新日期范围显示
        function updateDateRange() {
            const y = yearSelect.value;
            const m = monthSelect.value;
            const dateRangeElement = document.querySelector('.date-range');
            if (dateRangeElement) {
                dateRangeElement.textContent = `${y}.${m}.1-${getLastDayOfMonth(y, m)}`;
            }
        }

        // 获取指定年月的最后一天
        function getLastDayOfMonth(year, month) {
            const lastDay = new Date(year, month, 0);
            return lastDay.getDate();
        }

        // ========== 新的单元格事件处理 ===========
        
        // 处理单元格点击事件（单击选中，双击编辑）
        function handleCellClick(cell, e) {
            e.preventDefault();
            e.stopPropagation();
            
            // 如果是教室课表，不允许任何操作
            if (currentScheduleType === 'classroom') {
                return;
            }
            
            const currentTime = new Date().getTime();
            const isDoubleClick = (currentTime - lastClickTime) < 300;
            lastClickTime = currentTime;
            
            if (isDoubleClick && isAdmin) {
                // 双击操作 - 只有管理员可以
                const cellContent = cell.textContent.trim();
                if (cellContent) {
                    // 双击有内容的单元格 → 删除
                    deleteCell(cell);
                } else {
                    // 双击空单元格 → 编辑（创建）
                    editCell(cell);
                }
            } else {
                // 单击选中 - 所有用户都可以
                clearCellSelection();
                cell.classList.add('cell-selected');
                selectedCell = cell;
            }
        }
        
        // 处理鼠标按下事件（开始拖拽）
        function handleCellMouseDown(cell, e) {
            if (e.button !== 0) return; // 只处理左键
            
            // 只有管理员才能进行拖拽操作
            if (!isAdmin) {
                return;
            }
            
            // 如果是教室课表，不允许拖拽
            if (currentScheduleType === 'classroom') {
                return;
            }
            
            // 清除之前的选中状态
            clearCellSelection();
            clearDragState();
            
            // 只有有内容的单元格才能开始拖拽
            if (cell.textContent.trim()) {
                const dragStarted = startDrag(cell);
                if (dragStarted) {
                    e.preventDefault(); // 防止默认的文本选择
                }
            }
        }
        
        // 处理鼠标进入事件（拖拽过程中）
        function handleCellMouseEnter(cell, e) {
            if (isDragging) {
                handleDragMove(cell);
            } else {
                // 添加高亮效果（教室课表和学生课表都支持）
                highlightRowAndColumn(cell);
            }
        }
        
        // 处理鼠标离开事件
        function handleCellMouseLeave(cell, e) {
            // 如果不是拖拽状态，清除高亮效果
            if (!isDragging) {
                clearHighlight();
            }
        }
        
        // 高亮行和列
        function highlightRowAndColumn(cell) {
            // 先清除之前的高亮
            clearHighlight();
            
            const row = parseInt(cell.getAttribute('data-row'));
            const col = parseInt(cell.getAttribute('data-col'));
            const table = cell.closest('table');
            
            if (!table) return;
            
            // 高亮当前单元格
            cell.classList.add('cell-highlight');
            
            // 高亮同一行的所有单元格
            const rowCells = table.querySelectorAll(`td[data-row="${row}"]`);
            rowCells.forEach(rowCell => {
                if (rowCell !== cell) { // 避免重复添加当前单元格
                    rowCell.classList.add('row-highlight');
                }
            });
            
            // 高亮同一列的所有单元格
            const colCells = table.querySelectorAll(`td[data-col="${col}"]`);
            colCells.forEach(colCell => {
                if (colCell !== cell) { // 避免重复添加当前单元格
                    colCell.classList.add('col-highlight');
                }
            });
        }
        
        // 清除所有高亮效果
        function clearHighlight() {
            document.querySelectorAll('.row-highlight, .col-highlight, .cell-highlight').forEach(cell => {
                cell.classList.remove('row-highlight', 'col-highlight', 'cell-highlight');
            });
        }
        
        // 删除单元格内容（双击删除）
        function deleteCell(cell) {
            // 只有管理员才能删除
            if (!isAdmin) {
                alert('权限不足，只有管理员可以删除课程');
                return;
            }
            
            // 如果是教室课表，不允许删除（只读）
            if (currentScheduleType === 'classroom') {
                return;
            }
            
            const row = parseInt(cell.getAttribute('data-row'));
            const col = parseInt(cell.getAttribute('data-col'));
            const day = cell.getAttribute('data-day');
            const time = cell.getAttribute('data-time');
            const student = cell.getAttribute('data-student');
            const currentText = cell.textContent.trim();
            
            // 如果单元格为空，不需要删除
            if (!currentText) {
                return;
            }
            
            // 保存状态用于撤回
            if (currentScheduleType === 'student') {
                saveStateForUndo();
            }
            
            const month = yearSelect.value + '-' + monthSelect.value;
            const requestData = {
                month: month,
                campus: campusSelect.value,
                type: currentScheduleType,
                day_index: col,
                time_slot_index: row,
                subject: '',  // 空subject表示删除
                day_label: day,
                time_slot: time
            };
            
            if (currentScheduleType === 'classroom') {
                requestData.classroom = cell.getAttribute('data-classroom');
            } else {
                requestData.student_name = student;
            }
            
            fetch('/campus_schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json().catch(err => {
                    console.error('JSON解析失败:', err);
                    return { success: response.status === 200 };
                });
            })
            .then(data => {
                if (data.success) {
                    updateCellDisplay(cell, '');
                    clearCellSelection();
                    
                    // 若开启按周批量删除：仅在学生课表、管理员时触发
                    if (isAdmin && currentScheduleType === 'student' && repeatToggle && repeatToggle.checked) {
                        const rowIndex = row;
                        const editedColIndex = col;
                        const studentName = student;
                        // 异步执行，不阻塞主流程
                        batchDeleteWeekly(rowIndex, editedColIndex, studentName);
                    }
                } else {
                    alert('删除失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败: 网络错误或服务器错误');
            });
        }
        
        // 编辑单元格
        function editCell(cell) {
            // 只有管理员才能编辑
            if (!isAdmin) {
                alert('权限不足，只有管理员可以编辑课程表');
                return;
            }
            
            // 如果是教室课表，不允许编辑（只读）
            if (currentScheduleType === 'classroom') {
                return;
            }
            
            // 如果单元格已经在编辑中（包含input元素），直接返回
            if (cell.querySelector('input')) {
                return;
            }
            
            const row = parseInt(cell.getAttribute('data-row'));
            const col = parseInt(cell.getAttribute('data-col'));
            const day = cell.getAttribute('data-day');
            const time = cell.getAttribute('data-time');
            const classroom = cell.getAttribute('data-classroom');
            const student = cell.getAttribute('data-student');
            const currentText = cell.textContent.trim();
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.style.width = '100%';
            input.style.border = 'none';
            input.style.background = 'transparent';
            input.style.textAlign = 'center';
            input.style.fontSize = 'inherit';
            input.style.fontWeight = 'inherit';
            
            const originalContent = cell.innerHTML;
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
            
            function saveCell() {
                const newValue = input.value.trim();
                const month = yearSelect.value + '-' + monthSelect.value;
                
                // 只有内容发生变化且为学生课表时才保存状态用于撤回
                if (newValue !== currentText && currentScheduleType === 'student') {
                    saveStateForUndo();
                }
                
                const requestData = {
                    month: month,
                    campus: campusSelect.value,
                    type: currentScheduleType,
                    day_index: col,
                    time_slot_index: row,
                    subject: newValue,
                    day_label: day,
                    time_slot: time
                };
                
                if (currentScheduleType === 'classroom') {
                    requestData.classroom = classroom;
                } else {
                    requestData.student_name = student;
                }
                
                fetch('/campus_schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json().catch(err => {
                        console.error('JSON解析失败:', err);
                        // 如果JSON解析失败，返回一个假定成功的对象（如果HTTP状态码是200）
                        return { success: response.status === 200 };
                    });
                })
                .then(data => {
                    if (data.success) {
                        updateCellDisplay(cell, newValue);
                        // 编辑完成后清除选中状态
                        clearCellSelection();

                        // 若开启按周批量创建：仅在学生课表、管理员、从空白单元格创建新内容时触发
                        if (isAdmin && currentScheduleType === 'student' && repeatToggle && repeatToggle.checked && newValue && !currentText) {
                            const rowIndex = row;
                            const editedColIndex = col;
                            const studentName = student;
                            // 异步执行，不阻塞主流程
                            batchCreateWeekly(newValue, rowIndex, editedColIndex, studentName);
                        }
                        
                        // 若开启按周批量删除：仅在学生课表、管理员、从有内容删除为空时触发
                        if (isAdmin && currentScheduleType === 'student' && repeatToggle && repeatToggle.checked && !newValue && currentText) {
                            const rowIndex = row;
                            const editedColIndex = col;
                            const studentName = student;
                            // 异步执行，不阻塞主流程
                            batchDeleteWeekly(rowIndex, editedColIndex, studentName);
                        }
                    } else {
                        alert('保存失败: ' + (data.message || '未知错误'));
                        cell.innerHTML = originalContent;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('保存失败: 网络错误或服务器错误');
                    cell.innerHTML = originalContent;
                });
            }
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveCell();
                }
            });
            
            input.addEventListener('blur', function() {
                saveCell();
            });
        }
        
        // 按周批量创建（跨月），仅用于学生课表（管理员）
        async function batchCreateWeekly(subject, rowIndex, editedColIndex, studentName) {
            try {
                if (!repeatStart || !repeatEnd || !repeatStart.value || !repeatEnd.value) {
                    alert('请先设置开始和结束日期');
                    return;
                }
                // 使用本地解析避免时区导致的日期偏移
                const parseLocalDate = (s) => {
                    const parts = s.split('-');
                    const y = parseInt(parts[0], 10);
                    const m = parseInt(parts[1], 10) - 1;
                    const d = parseInt(parts[2], 10);
                    return new Date(y, m, d);
                };
                const start = parseLocalDate(repeatStart.value);
                const end = parseLocalDate(repeatEnd.value);
                if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                    alert('日期格式不正确');
                    return;
                }
                if (start > end) {
                    alert('开始日期不能晚于结束日期');
                    return;
                }

                // 当前编辑单元格的真实日期
                const baseYear = parseInt(yearSelect.value, 10);
                const baseMonthZero = parseInt(monthSelect.value, 10) - 1; // 0-11
                const editedDate = new Date(baseYear, baseMonthZero, editedColIndex + 1);

                // 找到范围内第一个与编辑日同星期的日期
                let first = new Date(editedDate);
                while (first > start) first.setDate(first.getDate() - 7);
                while (first < start) first.setDate(first.getDate() + 7);

                // 生成所有目标日期（排除已编辑当天）
                const targets = [];
                for (let d = new Date(first); d <= end; d.setDate(d.getDate() + 7)) {
                    const nd = new Date(d);
                    if (
                        nd.getFullYear() === editedDate.getFullYear() &&
                        nd.getMonth() === editedDate.getMonth() &&
                        nd.getDate() === editedDate.getDate()
                    ) {
                        continue;
                    }
                    targets.push(nd);
                }
                if (targets.length === 0) {
                    return;
                }

                // 按月聚合
                const monthKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const byMonth = {};
                targets.forEach(d => {
                    const k = monthKey(d);
                    if (!byMonth[k]) byMonth[k] = [];
                    byMonth[k].push(d);
                });

                // 预加载各月课表，做冲突检测
                const months = Object.keys(byMonth);
                const monthDataMap = {};
                await Promise.all(months.map(async (mstr) => {
                    try {
                        const url = `/campus_schedule_data?month=${mstr}&campus=${campusSelect.value}&type=student&student=${encodeURIComponent(studentName)}`;
                        const res = await fetch(url);
                        const json = await res.json();
                        monthDataMap[mstr] = (json && json.success && json.all_schedules) ? json.all_schedules[studentName] : null;
                    } catch (e) {
                        monthDataMap[mstr] = null;
                    }
                }));

                // 对缺失课表的月份，先创建学生课表
                const monthsToCreate = months.filter(mstr => !monthDataMap[mstr]);
                if (monthsToCreate.length > 0) {
                    await Promise.all(monthsToCreate.map(mstr => {
                        return fetch('/add_student_schedule', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                month: mstr,
                                campus: campusSelect.value,
                                student_name: studentName
                            })
                        }).catch(() => {});
                    }));
                }

                // 找出冲突日期
                const conflicts = [];
                targets.forEach(d => {
                    const k = monthKey(d);
                    const sched = monthDataMap[k];
                    const dayIdx = d.getDate() - 1; // 0-based
                    const occupied = sched && sched[rowIndex] && sched[rowIndex][dayIdx];
                    if (occupied) {
                        conflicts.push(`${k}-${String(d.getDate()).padStart(2,'0')} ${timeSlots[rowIndex]}`);
                    }
                });

                if (conflicts.length > 0) {
                    const ok = confirm(`以下时段已存在课程，确认覆盖吗？\n\n${conflicts.join('\n')}`);
                    if (!ok) return;
                }

                // 发送创建/覆盖请求
                const weekdayNames = ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'];
                const sleep = (ms) => new Promise(r => setTimeout(r, ms));
                const errors = [];
                for (const d of targets) {
                    const mstr = monthKey(d);
                    const dayIdx = d.getDate() - 1;
                    const dayLabel = weekdayNames[d.getDay()];
                    const timeSlotText = timeSlots[rowIndex];
                    const requestData = {
                        month: mstr,
                        campus: campusSelect.value,
                        type: 'student',
                        day_index: dayIdx,
                        time_slot_index: rowIndex,
                        subject: subject,
                        day_label: dayLabel,
                        time_slot: timeSlotText,
                        student_name: studentName
                    };
                    let attempt = 0;
                    let ok = false;
                    while (attempt < 3 && !ok) {
                        attempt++;
                        try {
                            console.log('[BatchCreate] POST', { mstr, dayIdx: dayIdx+1, timeSlotText, attempt });
                            const resp = await fetch('/campus_schedule', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(requestData)
                            });
                            let json;
                            try { json = await resp.json(); } catch (_) { json = { success: false, message: '响应解析失败' }; }
                            const message = (json && json.message) ? String(json.message) : '';
                            const isDeadlock = message.includes('Deadlock') || message.includes('1213');
                            if (resp.ok && json && json.success === true) {
                                ok = true;
                                console.log('[BatchCreate] OK', { mstr, day: dayIdx+1, timeSlotText });
                                break;
                            }
                            if (isDeadlock && attempt < 3) {
                                await sleep(120 * attempt);
                                continue;
                            }
                            throw new Error(`${mstr} 第${dayIdx+1}天 ${timeSlotText} 写入失败：${message || `请求失败 (${resp.status})`}`);
                        } catch (e) {
                            if (attempt >= 3) {
                                errors.push(e.message || String(e));
                            } else {
                                await sleep(120 * attempt);
                            }
                        }
                    }
                }
                if (errors.length > 0) {
                    alert('部分写入失败：\n' + errors.join('\n'));
                }

                // 同步更新当前月份可见表格中的相应单元格
                const visibleMonthKey = `${yearSelect.value}-${monthSelect.value}`;
                if (byMonth[visibleMonthKey]) {
                    const table = document.querySelector(`#schedule-${studentName}-table`);
                    if (table) {
                        byMonth[visibleMonthKey].forEach(d => {
                            const dayIdx = d.getDate() - 1;
                            const targetCell = table.querySelector(`td[data-row="${rowIndex}"][data-col="${dayIdx}"]`);
                            if (targetCell) {
                                updateCellDisplay(targetCell, subject);
                            }
                        });
                    }
                }
            } catch (err) {
                console.error('Batch create error:', err);
                alert('批量创建失败：' + (err && err.message ? err.message : '网络或数据错误'));
            }
        }

        // 批量删除课程（按周重复）
        async function batchDeleteWeekly(rowIndex, editedColIndex, studentName) {
            try {
                if (!repeatStart || !repeatEnd || !repeatStart.value || !repeatEnd.value) {
                    alert('请先设置开始和结束日期');
                    return;
                }
                // 使用本地解析避免时区导致的日期偏移
                const parseLocalDate = (s) => {
                    const parts = s.split('-');
                    const y = parseInt(parts[0], 10);
                    const m = parseInt(parts[1], 10) - 1;
                    const d = parseInt(parts[2], 10);
                    return new Date(y, m, d);
                };
                const start = parseLocalDate(repeatStart.value);
                const end = parseLocalDate(repeatEnd.value);
                if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                    alert('日期格式不正确');
                    return;
                }
                if (start > end) {
                    alert('开始日期不能晚于结束日期');
                    return;
                }

                // 当前编辑单元格的真实日期
                const baseYear = parseInt(yearSelect.value, 10);
                const baseMonthZero = parseInt(monthSelect.value, 10) - 1; // 0-11
                const editedDate = new Date(baseYear, baseMonthZero, editedColIndex + 1);

                // 找到范围内第一个与编辑日同星期的日期
                let first = new Date(editedDate);
                while (first > start) first.setDate(first.getDate() - 7);
                while (first < start) first.setDate(first.getDate() + 7);

                // 生成所有目标日期（排除已编辑当天）
                const targets = [];
                for (let d = new Date(first); d <= end; d.setDate(d.getDate() + 7)) {
                    const nd = new Date(d);
                    if (
                        nd.getFullYear() === editedDate.getFullYear() &&
                        nd.getMonth() === editedDate.getMonth() &&
                        nd.getDate() === editedDate.getDate()
                    ) {
                        continue;
                    }
                    targets.push(nd);
                }
                if (targets.length === 0) {
                    return;
                }

                // 按月聚合
                const monthKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const byMonth = {};
                targets.forEach(d => {
                    const k = monthKey(d);
                    if (!byMonth[k]) byMonth[k] = [];
                    byMonth[k].push(d);
                });

                // 发送删除请求（使用POST + 空subject）
                const weekdayNames = ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'];
                const sleep = (ms) => new Promise(r => setTimeout(r, ms));
                const errors = [];
                for (const d of targets) {
                    const mstr = monthKey(d);
                    const dayIdx = d.getDate() - 1;
                    const dayLabel = weekdayNames[d.getDay()];
                    const timeSlotText = timeSlots[rowIndex];
                    const requestData = {
                        month: mstr,
                        campus: campusSelect.value,
                        type: 'student',
                        day_index: dayIdx,
                        time_slot_index: rowIndex,
                        subject: '',  // 空subject表示删除
                        day_label: dayLabel,
                        time_slot: timeSlotText,
                        student_name: studentName
                    };
                    let attempt = 0;
                    let ok = false;
                    while (attempt < 3 && !ok) {
                        attempt++;
                        try {
                            console.log('[BatchDelete] POST (空subject)', { mstr, dayIdx: dayIdx+1, timeSlotText, attempt });
                            const resp = await fetch('/campus_schedule', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(requestData)
                            });
                            let json;
                            try { json = await resp.json(); } catch (_) { json = { success: false, message: '响应解析失败' }; }
                            const message = (json && json.message) ? String(json.message) : '';
                            const isDeadlock = message.includes('Deadlock') || message.includes('1213');
                            if (resp.ok && json && json.success === true) {
                                ok = true;
                                console.log('[BatchDelete] OK', { mstr, day: dayIdx+1, timeSlotText });
                                break;
                            }
                            if (isDeadlock && attempt < 3) {
                                await sleep(120 * attempt);
                                continue;
                            }
                            throw new Error(`${mstr} 第${dayIdx+1}天 ${timeSlotText} 删除失败：${message || `请求失败 (${resp.status})`}`);
                        } catch (e) {
                            if (attempt >= 3) {
                                errors.push(e.message || String(e));
                            } else {
                                await sleep(120 * attempt);
                            }
                        }
                    }
                }
                if (errors.length > 0) {
                    alert('部分删除失败：\n' + errors.join('\n'));
                }

                // 同步更新当前月份可见表格中的相应单元格
                const visibleMonthKey = `${yearSelect.value}-${monthSelect.value}`;
                if (byMonth[visibleMonthKey]) {
                    const table = document.querySelector(`#schedule-${studentName}-table`);
                    if (table) {
                        byMonth[visibleMonthKey].forEach(d => {
                            const dayIdx = d.getDate() - 1;
                            const targetCell = table.querySelector(`td[data-row="${rowIndex}"][data-col="${dayIdx}"]`);
                            if (targetCell) {
                                updateCellDisplay(targetCell, '');
                            }
                        });
                    }
                }
            } catch (err) {
                console.error('Batch delete error:', err);
                alert('批量删除失败：' + (err && err.message ? err.message : '网络或数据错误'));
            }
        }

        function updateCellDisplay(cell, subject) {
            // 清除原有的class
            cell.className = cell.className.replace(/subject-\w+/g, '');
            
            if (subject) {
                // 如果包含换行，说明是教室课表格式（科目\n学生姓名）
                let actualSubject = subject;
                if (subject.includes('\n')) {
                    actualSubject = subject.split('\n')[0]; // 取第一行作为科目名
                }
                
                // 根据科目添加对应的class
                let subjectClass = '';
                if (actualSubject === '化学') {
                    subjectClass = 'subject-chemistry';
                } else if (actualSubject === '数学') {
                    subjectClass = 'subject-math';
                } else if (actualSubject === '物理') {
                    subjectClass = 'subject-physics';
                } else if (actualSubject === '语文') {
                    subjectClass = 'subject-chinese';
                } else if (actualSubject === '英语') {
                    subjectClass = 'subject-english';
                } else if (actualSubject === '政治') {
                    subjectClass = 'subject-politics';
                } else if (actualSubject === '历史') {
                    subjectClass = 'subject-history';
                } else if (actualSubject === '地理') {
                    subjectClass = 'subject-geography';
                }
                
                if (subjectClass) {
                    cell.classList.add(subjectClass);
                }
                cell.textContent = subject;
            } else {
                cell.textContent = '';
            }
        }
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        body {
            background: #f8dbe2;
            font-family: '微软雅黑', Arial, sans-serif;
        }
        .main-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #ff6f91;
            margin-top: 30px;
            letter-spacing: 2px;
        }
        .date-range {
            text-align: center;
            font-size: 1.3rem;
            color: #ff6f91;
            margin-bottom: 20px;
        }
        .schedule-table {
            margin: 0 auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-collapse: separate;
            border-spacing: 0;
            overflow-x: auto;
            width: 98vw;
            min-width: 1200px;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #e0e0e0;
            text-align: center;
            padding: 8px 6px;
            min-width: 70px;
            font-size: 1rem;
        }
        .schedule-table th {
            background: #ffe3ec;
            color: #ff6f91;
            font-weight: bold;
        }
        .schedule-table td {
            background: #fff;
        }
        .schedule-table .subject-chemistry {
            background: #ffd6af !important;
            color: #333;
            font-weight: bold;
        }
        .schedule-table .subject-math {
            background: #c7d8f4 !important;
            color: #333;
            font-weight: bold;
        }
        .schedule-table .subject-physics {
            background: #ffb3b3 !important;
            color: #333;
            font-weight: bold;
        }
        .schedule-table .subject-chinese {
            background: #ffe4e1 !important;
            color: #333;
            font-weight: bold;
        }
        .schedule-table .subject-english {
            background: #d4ffd4 !important;
            color: #333;
            font-weight: bold;
        }
        .schedule-table .subject-politics {
            background: #e6d3ff !important;
            color: #333;
            font-weight: bold;
        }
        .schedule-table .subject-history {
            background: #fff8dc !important;
            color: #333;
            font-weight: bold;
        }
        .schedule-table .subject-geography {
            background: #b3e5fc !important;
            color: #333;
            font-weight: bold;
        }
        .rest-cell {
            background: #f8f8f8;
            color: #888;
            font-size: 1.1rem;
        }
        .time-label {
            background: #ffe3ec;
            color: #ff6f91;
            font-weight: bold;
            min-width: 90px;
        }
        @media (max-width: 1200px) {
            .schedule-table {
                min-width: 900px;
            }
        }
    </style>
</head>
<body>
    <div class="main-title">{{ title }}</div>
    <div class="date-range">{{ date_range }}</div>
    <div style="text-align:center; margin-bottom: 18px;">
        <form id="monthForm" style="display:inline-block;">
            <label style="font-weight:bold;color:#ff6f91;">选择月份：</label>
            <select id="yearSelect" name="year" style="margin-right:6px;"></select>
            <select id="monthSelect" name="month"></select>
        </form>
    </div>

    <!-- 文德福课程表 -->
    <div style="margin-bottom: 40px;">
        <h2 style="text-align: center; color: #ff6f91; font-size: 1.8rem; margin-bottom: 20px;">文德福</h2>
        <div style="overflow-x:auto;">
            {% set subject_map = {'化学': 'chemistry', '数学': 'math', '物理': 'physics', '语文': 'chinese', '英语': 'english', '政治': 'politics', '历史': 'history', '地理': 'geography'} %}
            <table class="schedule-table" id="wendefu-table">
                <thead>
                    <tr>
                        <th class="time-label">时间/日期</th>
                        <!-- 其余日期th由JS动态生成 -->
                    </tr>
                </thead>
                <tbody>
                    {% for row_idx in range(time_slots|length) %}
                    <tr>
                        <th class="time-label">
                            {{ time_slots[row_idx] }}
                            {% if row_idx == 0 %}<div>上午</div>{% elif row_idx == 4 %}<div>下午</div>{% elif row_idx == 8 %}<div>晚上</div>{% endif %}
                        </th>
                        {% for col_idx in range(days|length) %}
                            <td onclick="editCell(this, 'wendefu')"
                                data-row="{{ row_idx }}"
                                data-col="{{ col_idx }}"
                                data-day="{{ days[col_idx] }}"
                                data-time="{{ time_slots[row_idx] }}"
                                data-campus="wendefu"
                                style="cursor: pointer;"></td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 翠海课程表 -->
    <div style="margin-bottom: 40px;">
        <h2 style="text-align: center; color: #ff6f91; font-size: 1.8rem; margin-bottom: 20px;">翠海</h2>
        <div style="overflow-x:auto;">
            <table class="schedule-table" id="cuihai-table">
                <thead>
                    <tr>
                        <th class="time-label">时间/日期</th>
                        <!-- 其余日期th由JS动态生成 -->
                    </tr>
                </thead>
                <tbody>
                    {% for row_idx in range(time_slots|length) %}
                    <tr>
                        <th class="time-label">
                            {{ time_slots[row_idx] }}
                            {% if row_idx == 0 %}<div>上午</div>{% elif row_idx == 4 %}<div>下午</div>{% elif row_idx == 8 %}<div>晚上</div>{% endif %}
                        </th>
                        {% for col_idx in range(days|length) %}
                            <td onclick="editCell(this, 'cuihai')"
                                data-row="{{ row_idx }}"
                                data-col="{{ col_idx }}"
                                data-day="{{ days[col_idx] }}"
                                data-time="{{ time_slots[row_idx] }}"
                                data-campus="cuihai"
                                style="cursor: pointer;"></td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 玮鹏课程表 -->
    <div style="margin-bottom: 40px;">
        <h2 style="text-align: center; color: #ff6f91; font-size: 1.8rem; margin-bottom: 20px;">玮鹏</h2>
        <div style="overflow-x:auto;">
            <table class="schedule-table" id="weipeng-table">
                <thead>
                    <tr>
                        <th class="time-label">时间/日期</th>
                        <!-- 其余日期th由JS动态生成 -->
                    </tr>
                </thead>
                <tbody>
                    {% for row_idx in range(time_slots|length) %}
                    <tr>
                        <th class="time-label">
                            {{ time_slots[row_idx] }}
                            {% if row_idx == 0 %}<div>上午</div>{% elif row_idx == 4 %}<div>下午</div>{% elif row_idx == 8 %}<div>晚上</div>{% endif %}
                        </th>
                        {% for col_idx in range(days|length) %}
                            <td onclick="editCell(this, 'weipeng')"
                                data-row="{{ row_idx }}"
                                data-col="{{ col_idx }}"
                                data-day="{{ days[col_idx] }}"
                                data-time="{{ time_slots[row_idx] }}"
                                data-campus="weipeng"
                                style="cursor: pointer;"></td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ========== 月份选择控件 ===========
        const currentMonth = "{{ current_month }}";
        const [curYear, curMonth] = currentMonth.split('-');
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        // 年份范围
        for(let y=2020; y<=2030; y++) {
            let opt = document.createElement('option');
            opt.value = y;
            opt.text = y + '年';
            if(y == curYear) opt.selected = true;
            yearSelect.appendChild(opt);
        }
        // 月份
        for(let m=1; m<=12; m++) {
            let opt = document.createElement('option');
            opt.value = (m<10 ? '0'+m : m);
            opt.text = m + '月';
            if(m == parseInt(curMonth)) opt.selected = true;
            monthSelect.appendChild(opt);
        }
        // 切换时动态更新页面
        yearSelect.onchange = monthSelect.onchange = function() {
            const y = yearSelect.value;
            const m = monthSelect.value;
            
            // 更新URL但不刷新页面
            const newUrl = '?month=' + y + '-' + m;
            window.history.pushState({}, '', newUrl);
            
            // 更新日期范围显示
            updateDateRange();
            
            // 重新加载所有校区的数据
            loadCampusData('wendefu');
            loadCampusData('cuihai');
            loadCampusData('weipeng');
        };

        // 页面加载时加载所有校区的数据
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟加载，确保页面完全加载后再加载数据
            setTimeout(function() {
                loadCampusData('wendefu');
                loadCampusData('cuihai');
                loadCampusData('weipeng');
                updateDateRange();
            }, 100);
        });

        // 加载指定校区的数据
        function loadCampusData(campus) {
            const month = yearSelect.value + '-' + monthSelect.value;
            fetch(`/campus_schedule_data?month=${month}&campus=${campus}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateTableHeader(campus, data.days);
                        updateCampusTable(campus, data.schedule);
                    }
                })
                .catch(error => {
                    console.error('Error loading campus data:', error);
                });
        }

        // 更新指定校区的表格
        function updateCampusTable(campus, scheduleData) {
            const table = document.getElementById(campus + '-table');
            if (!table) return;

            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            
            for (let rowIdx = 0; rowIdx < rows.length; rowIdx++) {
                const cells = rows[rowIdx].querySelectorAll('td');
                for (let colIdx = 0; colIdx < scheduleData[0].length; colIdx++) {
                    const cell = cells[colIdx];
                    const subject = scheduleData[rowIdx] && scheduleData[rowIdx][colIdx];
                    // 清除原有的class
                    cell.className = cell.className.replace(/subject-\w+/g, '');
                    if (subject) {
                        let subjectClass = '';
                        if (subject === '化学') subjectClass = 'subject-chemistry';
                        else if (subject === '数学') subjectClass = 'subject-math';
                        else if (subject === '物理') subjectClass = 'subject-physics';
                        else if (subject === '语文') subjectClass = 'subject-chinese';
                        else if (subject === '英语') subjectClass = 'subject-english';
                        else if (subject === '政治') subjectClass = 'subject-politics';
                        else if (subject === '历史') subjectClass = 'subject-history';
                        else if (subject === '地理') subjectClass = 'subject-geography';
                        if (subjectClass) cell.classList.add(subjectClass);
                        cell.textContent = subject;
                    } else {
                        cell.textContent = '';
                    }
                }
            }
        }

        // 动态更新表头
        function updateTableHeader(campus, days) {
            const table = document.getElementById(campus + '-table');
            if (!table) return;
            const thead = table.querySelector('thead');
            if (!thead) return;
            const headerRow = thead.querySelector('tr');
            // 保留第一个th（时间/日期），其余全部移除
            while (headerRow.children.length > 1) {
                headerRow.removeChild(headerRow.lastChild);
            }
            // 添加新的日期th
            days.forEach(day => {
                const th = document.createElement('th');
                th.textContent = day;
                headerRow.appendChild(th);
            });
        }

        // 更新日期范围显示
        function updateDateRange() {
            const y = yearSelect.value;
            const m = monthSelect.value;
            const dateRangeElement = document.querySelector('.date-range');
            if (dateRangeElement) {
                dateRangeElement.textContent = `${y}.${m}.1-${getLastDayOfMonth(y, m)}`;
            }
        }

        // 获取指定年月的最后一天
        function getLastDayOfMonth(year, month) {
            const lastDay = new Date(year, month, 0);
            return lastDay.getDate();
        }

        // ========== 编辑单元格时带上month和campus ==========
        function editCell(cell, campus) {
            const row = parseInt(cell.getAttribute('data-row'));
            const col = parseInt(cell.getAttribute('data-col'));
            const day = cell.getAttribute('data-day');
            const time = cell.getAttribute('data-time');
            const currentText = cell.textContent.trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.style.width = '100%';
            input.style.border = 'none';
            input.style.background = 'transparent';
            input.style.textAlign = 'center';
            input.style.fontSize = 'inherit';
            input.style.fontWeight = 'inherit';
            const originalContent = cell.innerHTML;
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
            function saveCell() {
                const newValue = input.value.trim();
                // 取当前month
                const month = yearSelect.value + '-' + monthSelect.value;
                fetch('/campus_schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        month: month,
                        campus: campus,
                        day_index: col,
                        time_slot_index: row,
                        subject: newValue,
                        day_label: day,
                        time_slot: time
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateCellDisplay(cell, newValue);
                        // 重新加载对应校区的数据
                        loadCampusData(campus);
                    } else {
                        alert('保存失败: ' + (data.message || '未知错误'));
                        cell.innerHTML = originalContent;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('保存失败: 网络错误');
                    cell.innerHTML = originalContent;
                });
            }
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveCell();
                }
            });
            input.addEventListener('blur', function() {
                saveCell();
            });
        }
        
        function updateCellDisplay(cell, subject) {
            // 清除原有的class
            cell.className = cell.className.replace(/subject-\w+/g, '');
            
            if (subject) {
                // 根据科目添加对应的class
                let subjectClass = '';
                if (subject === '化学') {
                    subjectClass = 'subject-chemistry';
                } else if (subject === '数学') {
                    subjectClass = 'subject-math';
                } else if (subject === '物理') {
                    subjectClass = 'subject-physics';
                } else if (subject === '语文') {
                    subjectClass = 'subject-chinese';
                } else if (subject === '英语') {
                    subjectClass = 'subject-english';
                } else if (subject === '政治') {
                    subjectClass = 'subject-politics';
                } else if (subject === '历史') {
                    subjectClass = 'subject-history';
                } else if (subject === '地理') {
                    subjectClass = 'subject-geography';
                }
                
                if (subjectClass) {
                    cell.classList.add(subjectClass);
                }
                cell.textContent = subject;
            } else {
                cell.textContent = '';
            }
        }
    </script>
</body>
</html> 